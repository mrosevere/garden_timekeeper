{% extends "core/base.html" %}
{% block content %}

<!-- ======================================================== -->
<!-- PAGE HEADER -->
<!-- ======================================================== -->
<div class="container py-2">
  <div class="d-flex flex-column flex-sm-row justify-content-between align-items-center mb-4 text-center text-sm-start">
    <h1 class="h3 mb-3 px-2">Garden Beds</h1>
    <div>
      <a href="{% url 'bed_create' %}" class="btn btn-primary">Add Bed</a>
    </div>
  </div>
</div>

<!-- ======================================================== -->
<!-- FILTER BAR (Desktop Open, Mobile Collapsible) -->
<!-- ======================================================== -->
<div class="container mb-4">
  <div class="card shadow-sm">
    <div class="card-body">

      <!-- Mobile Toggle Button -->
      <div class="d-md-none mb-3">
        <button class="btn btn-secondary w-100"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#bedFilters"
                aria-expanded="false"
                aria-controls="bedFilters">
          <i class="bi bi-funnel me-1"></i> Show Filters
        </button>
      </div>

      <!-- Collapsible Filter Area -->
      <div class="collapse d-md-block" id="bedFilters">
        <form method="get" class="row g-3">

          <!-- Search -->
          <div class="col-md-4">
            <label class="form-label">Search</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" name="search" class="form-control" placeholder="Search beds..."
                     value="{{ request.GET.search }}">
            </div>
          </div>

          <!-- Location -->
          <div class="col-md-4">
            <label class="form-label">Location</label>
            <select name="location" class="form-select">
              <option value="">All</option>
              {% for val, label in location_choices %}
                <option value="{{ val }}" {% if request.GET.location == val %}selected{% endif %}>
                  {{ label }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Apply + Reset -->
          <div class="col-12 col-md-2 d-flex gap-2 align-items-end">
            <button class="btn btn-primary flex-fill">Apply</button>
            <a href="{% url 'bed_list' %}" class="btn btn-secondary flex-fill">Reset</a>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>

<!-- ======================================================== -->
<!-- MOBILE CARD VIEW (below md) -->
<!-- ======================================================== -->
<div class="d-block d-md-none container mb-4">
  <div class="row g-3">
    {% for bed in object_list %}
    <div class="col-12">
      <div class="card shadow-sm">

        <!-- Card Header -->
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="mb-0 h5">
            <a href="{% url 'bed_detail' bed.pk %}">{{ bed.name }}</a>
          </h2>
        </div>

        <!-- Card Body -->
        <div class="card-body">
          <div class="mb-2"><strong>Location:</strong> {{ bed.location|default:"—" }}</div>
          <div class="mb-2"><strong>Created:</strong> {{ bed.created_at|date:"Y-m-d" }}</div>
        </div>

        <!-- Card Footer -->
        <div class="card-footer d-flex justify-content-end gap-2">
          <a href="{% url 'bed_edit' bed.pk %}" class="btn btn-sm btn-primary" style="min-width: 60px;">Edit</a>
          <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal-{{ bed.pk }}">Delete</button>
        </div>

      </div>
    </div>
    <!-- Display message if no beds exist or no beds match filters -->
    {% empty %}
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body text-center text-muted">
          {% if total_beds == 0 %}
            You don’t have any garden beds yet.
          {% else %}
            No beds match your filters.
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}

  </div>
</div>

<!-- ======================================================== -->
<!-- DESKTOP TABLE VIEW (md and above) -->
<!-- ======================================================== -->
<div class="d-none d-md-block">
  <div class="container mb-4">
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            {% for option in sort_options %}
            <th>
              <a href="?sort={{ option.field }}&direction={% if current_sort == option.field and current_direction == 'asc' %}desc{% else %}asc{% endif %}&search={{ request.GET.search }}&location={{ request.GET.location }}">
                {{ option.label }}
                {% if current_sort == option.field %}
                  {% if current_direction == "asc" %}
                    <i class="fa-solid fa-arrow-up ms-1"></i>
                  {% else %}
                    <i class="fa-solid fa-arrow-down ms-1"></i>
                  {% endif %}
                {% endif %}
              </a>
            </th>
            {% endfor %}
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <!-- Table body -->
        <tbody>
          {% for bed in object_list %}
          <tr>
            <td><a href="{% url 'bed_detail' bed.pk %}">{{ bed.name }}</a></td>
            <td>{{ bed.location|default:"—" }}</td>
            <td>{{ bed.created_at|date:"Y-m-d" }}</td>
            <td class="text-end">
              <a href="{% url 'bed_edit' bed.pk %}" class="btn btn-sm btn-primary me-2" style="min-width: 60px;">Edit</a>
              <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal-{{ bed.pk }}">Delete</button>
            </td>
          </tr>
          <!-- Show message if no beds exist or no beds match filters -->
          {% empty %} 
          <tr>
            <td colspan="{{ sort_options|length|add:'1' }}" class="text-center text-muted py-4">
              {% if total_beds == 0 %} 
                You don’t have any garden beds yet. 
              {% else %}
                No beds match your filters. 
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ======================================================== -->
<!-- PAGINATION -->
<!-- ======================================================== -->
{% if is_paginated %}
<div class="container mb-4">
  <nav aria-label="Bed list pagination">
    <ul class="pagination justify-content-center flex-wrap gap-1">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page=1&search={{ request.GET.search }}&location={{ request.GET.location }}&sort={{ current_sort }}&direction={{ current_direction }}" aria-label="First">&laquo;&laquo;</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}&search={{ request.GET.search }}&location={{ request.GET.location }}&sort={{ current_sort }}&direction={{ current_direction }}" aria-label="Previous">&laquo;</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">&laquo;&laquo;</span></li>
        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
      {% endif %}

      {% for num in paginator.page_range %}
        {% if num == page_obj.number %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% elif num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
          <li class="page-item"><a class="page-link" href="?page={{ num }}&search={{ request.GET.search }}&location={{ request.GET.location }}&sort={{ current_sort }}&direction={{ current_direction }}">{{ num }}</a></li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&search={{ request.GET.search }}&location={{ request.GET.location }}&sort={{ current_sort }}&direction={{ current_direction }}" aria-label="Next">&raquo;</a></li>
        <li class="page-item"><a class="page-link" href="?page={{ paginator.num_pages }}&search={{ request.GET.search }}&location={{ request.GET.location }}&sort={{ current_sort }}&direction={{ current_direction }}" aria-label="Last">&raquo;&raquo;</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
        <li class="page-item disabled"><span class="page-link">&raquo;&raquo;</span></li>
      {% endif %}
    </ul>
  </nav>
</div>
{% endif %}

<!-- ======================================================== -->
<!-- DELETE MODALS -->
<!-- ======================================================== -->
{% for bed in object_list %}
<div class="modal fade" id="deleteModal-{{ bed.pk }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5">Delete Garden Bed</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete <strong>{{ bed.name }}</strong>?
      </div>
      <div class="modal-footer">
        <form method="post" action="{% url 'bed_delete' bed.pk %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Yes, delete</button>
        </form>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% endblock %}
