{% extends "core/base.html" %} 
{% load month_filters %}
{% block content %}


<div class="container py-4">  

  <!-- DASHBOARD TOP CONTROLS -->
  <div class="d-flex justify-content-between align-items-center mb-4">
      
      <!-- Left: Page Title -->
      <h1 class="h3 mb-0 px-3">Dashboard</h1>

      <!-- Right: Action Buttons -->
       <div class="btn-group">
          <a href="{% url 'plant_create' %}" class="btn btn-outline-primary">Add Plant</a>
          <a href="{% url 'bed_create' %}" class="btn btn-outline-primary">Add Bed</a>
       </div>
      
  </div>
</div>

<div class="container mb-4">

    <div class="d-flex justify-content-between align-items-center">

        <!-- Left: Selected Month -->
        <h2 class="h4 mb-0">
            <!-- passed from the month_filters -->
            {{ selected_month|month_name }} {{ selected_year }}

        </h2>

        <!-- Right: Navigation Buttons -->
        <div class="btn-group">

            <!-- Today Button -->
            <a href="?view=month&sort={{ current_sort }}&direction={{ current_direction }}&hide_overdue={{ hide_overdue|yesno:"1," }}
"
               class="btn btn-outline-secondary">
                Today
            </a>


            <!-- Previous Month (disabled only if we are in the current month, to stop backwards nav) -->
            {% if selected_year == today.year and selected_month == today.month %}
                <!-- At current month: disable -->
                <button class="btn btn-outline-secondary" disabled>
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
            {% else %}
                <!-- Otherwise: allow navigation -->
                <a href="?view=month&year={{ previous_year }}&month={{ previous_month }}&sort={{ current_sort }}&direction={{ current_direction }}&hide_overdue={{ hide_overdue|yesno:"1," }}"
                class="btn btn-outline-secondary">
                    <i class="fa-solid fa-chevron-left"></i>
                </a>
            {% endif %}


            <!-- Next Month -->
            <a href="?view=month&year={{ next_year }}&month={{ next_month }}&sort={{ current_sort }}&direction={{ current_direction }}&hide_overdue={{ hide_overdue|yesno:"1," }}
"
            class="btn btn-outline-secondary">
                <i class="fa-solid fa-chevron-right"></i>
            </a>

            <!-- Jump to Month to display the next 12 months (even if that rolls over the year) -->
            <div class="btn-group ms-2">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    Jump toâ€¦
                </button>

                <ul class="dropdown-menu">

                    <!-- Current Year -->
                    <li><h6 class="dropdown-header">{{ today.year }}</h6></li>

                    {% for m in today.month|to:12 %}
                        <li>
                            <a class="dropdown-item"
                            href="?view=month&year={{ today.year }}&month={{ m }}&sort={{ current_sort }}&direction={{ current_direction }}">
                                {{ m|month_name }}
                            </a>
                        </li>
                    {% endfor %}

                    <li><hr class="dropdown-divider"></li>

                    <!-- Next Year -->
                    <li><h6 class="dropdown-header">{{ today.year|add:"1" }}</h6></li>

                    {% for m in 1|to:12 %}
                        <li>
                            <a class="dropdown-item"
                            href="?view=month&year={{ today.year|add:'1' }}&month={{ m }}&sort={{ current_sort }}&direction={{ current_direction }}">
                                {{ m|month_name }}
                            </a>
                        </li>
                    {% endfor %}

                </ul>
            </div>







        </div>

    </div>

</div>

<!-- Checkbox to hide overdue tasks -->
<form method="get" class="d-inline">
    <input type="hidden" name="view" value="month">
    <input type="hidden" name="year" value="{{ selected_year }}">
    <input type="hidden" name="month" value="{{ selected_month }}">
    <input type="hidden" name="sort" value="{{ current_sort }}">
    <input type="hidden" name="direction" value="{{ current_direction }}">

    <div class="form-check d-inline-block ms-3">
        <input class="form-check-input"
               type="checkbox"
               name="hide_overdue"
               value="1"
               id="hideOverdueCheck"
               {% if hide_overdue %}checked{% endif %}
               onchange="this.form.submit()">

        <label class="form-check-label" for="hideOverdueCheck">
            Hide overdue tasks
        </label>
    </div>
</form>

<!-- Table of tasks -->
<div class="container">
<table class="table table-striped align-middle">
    <!-- Table Header (sortable columns) -->
<thead>
    <tr>
        <th>Complete?</th>

        <!-- Task -->
        <th>
            <a href="?sort=name&direction={% if current_sort == 'name' and current_direction == 'asc' %}desc{% else %}asc{% endif %}">
                Task
                {% if current_sort == "name" %}
                    {% if current_direction == "asc" %}
                        <i class="fa-solid fa-arrow-up ms-1"></i>
                    {% else %}
                        <i class="fa-solid fa-arrow-down ms-1"></i>
                    {% endif %}
                {% endif %}
            </a>
        </th>

        <!-- Plant -->
        <th>
            <a href="?sort=plant&direction={% if current_sort == 'plant' and current_direction == 'asc' %}desc{% else %}asc{% endif %}">
                Plant
                {% if current_sort == "plant" %}
                    {% if current_direction == "asc" %}
                        <i class="fa-solid fa-arrow-up ms-1"></i>
                    {% else %}
                        <i class="fa-solid fa-arrow-down ms-1"></i>
                    {% endif %}
                {% endif %}
            </a>
        </th>

        <!-- Bed -->
        <th class="d-none d-md-table-cell">
            <a href="?sort=bed&direction={% if current_sort == 'bed' and current_direction == 'asc' %}desc{% else %}asc{% endif %}">
                Bed
                {% if current_sort == "bed" %}
                    {% if current_direction == "asc" %}
                        <i class="fa-solid fa-arrow-up ms-1"></i>
                    {% else %}
                        <i class="fa-solid fa-arrow-down ms-1"></i>
                    {% endif %}
                {% endif %}
            </a>
        </th>

        <!-- Due -->
        <th>
            <a href="?sort=due&direction={% if current_sort == 'due' and current_direction == 'asc' %}desc{% else %}asc{% endif %}">
                Due
                {% if current_sort == "due" %}
                    {% if current_direction == "asc" %}
                        <i class="fa-solid fa-arrow-up ms-1"></i>
                    {% else %}
                        <i class="fa-solid fa-arrow-down ms-1"></i>
                    {% endif %}
                {% endif %}
            </a>
        </th>

        <!-- Frequency -->
        <th class="d-none d-md-table-cell">
            <a href="?sort=frequency&direction={% if current_sort == 'frequency' and current_direction == 'asc' %}desc{% else %}asc{% endif %}">
                Frequency
                {% if current_sort == "frequency" %}
                    {% if current_direction == "asc" %}
                        <i class="fa-solid fa-arrow-up ms-1"></i>
                    {% else %}
                        <i class="fa-solid fa-arrow-down ms-1"></i>
                    {% endif %}
                {% endif %}
            </a>
        </th>

        <th class="text-end">Actions</th>
    </tr>
</thead>


    <!-- table body -->
    <tbody>
        {% for task in tasks %}
        <!-- Conditional logic for row highlighting based on due date -->
        <tr
        {% if task.next_due < start_of_month %}
            class="table-danger"
        {% elif task.next_due == today %}
            class="table-warning"
        {% endif %}

          <!-- Complete? -->
          <td>
                <form method="POST" action="{% url 'task_mark_done' task.id %}" class="d-inline">
                    {% csrf_token %}
                    <input type="checkbox" onChange="this.form.submit()">
                </form>
          </td>

          <!-- Task -->
          <td>
            <a href="{% url 'task_detail' task.id %}">
                {{ task.name }}
            </a>
          </td>

          <!--  Plant -->
          <td>
              <a href="{% url 'plant_detail' task.plant.id %}">
                  {{ task.plant.name }}
              </a>
          </td>

          <!-- bed -->
          <td class="d-none d-md-table-cell">
              <a href="{% url 'bed_detail' task.plant.bed.id %}">
                  {{ task.plant.bed.name }}
              </a>
          </td>

          <!-- Due -->
          <td>
            {% if task.next_due < start_of_month %}
                <i class="fa-solid fa-circle-exclamation text-danger ms-2"></i>
            {% elif task.next_due == today %}
                <i class="fa-solid fa-circle-exclamation text-warning ms-2"></i>
            {% endif %}
            {{ task.next_due }}
          </td>
           <td class="d-none d-md-table-cell">
              {{ task.get_frequency_display }}
          </td>

          <!-- Actions -->
          <td class="text-end">
              <a href="{% url 'task_update' task.id %}" class="btn btn-sm btn-outline-secondary">Edit</a>
              <a href="{% url 'task_delete' task.id %}" class="btn btn-sm btn-outline-danger">Delete</a>
          </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center text-muted py-4">
                Congratulations! You don't have any tasks due with your current filters!
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

</div>

{% endblock %}
