{% extends "core/base.html" %} 
{% load month_filters %}
{% load static %}

{% block content %}

<!-- DASHBOARD TOP CONTROLS -->
<div class="container py-2">   
  <div class="d-flex flex-column flex-sm-row justify-content-between align-items-center mb-4 text-center text-sm-start">
      
      <!-- Page Title -->
      <h1 class="h3 mb-3 px-2">Dashboard - My Tasks</h1>

      <!-- Action Buttons -->
       <div>
          <a href="{% url 'plant_create' %}" class="btn btn-primary me-2" aria-label="Add Plant">Add Plant</a>
          <a href="{% url 'bed_create' %}" class="btn btn-primary me-2">Add Bed</a>
       </div>
  </div>
</div>

<!-- DATE SELECTOR BUTTONS -->
<div class="container mb-4">         <!-- Outer container -->
    <div class="row align-items-center">   <!-- Row for header + controls -->
        <!-- Column 1: Selected Month -->
        <div class="col-auto">  

            <!-- Selected Month Heading (e.g., "February 2026") -->
            <h2 class="h4 mb-0">
                <!-- passed from the month_filters -->
                {{ selected_month|month_name }} {{ selected_year }}
            </h2>
        </div>  <!-- Column 1: Selected Month -->

        <!-- Column 2: Navigation Buttons + Dropdown -->
        <div class="col-auto ms-auto d-flex flex-wrap align-items-center gap-2">
            
            <!-- Button Group for Today / Prev / Next -->
             <div class="btn-group">
                
                <!-- Today Button -->
                <a href="?view=month&sort={{ current_sort }}&direction={{ current_direction }}&hide_overdue={{ hide_overdue|yesno:'1,' }}" class="btn btn-outline-secondary">
                    Today</a>
                
                <!-- Previous Month Arrow button -->
                <!--Disable button if we are in the current month to stop users navigating into past months -->
                {% if selected_year == today.year and selected_month == today.month %}
                    <button class="btn btn-outline-secondary" aria-label="Previous Month (disabled)" disabled>
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                <!-- Otherwise: enable previous month navigation -->
                {% else %}                
                    <a href="?view=month&year={{ previous_year }}&month={{ previous_month }}&sort={{ current_sort }}&direction={{ current_direction }}&hide_overdue={{ hide_overdue|yesno:"1," }}"
                    class="btn btn-outline-secondary" aria-label="Previous Month">
                        <i class="fa-solid fa-chevron-left"></i>
                    </a>
                {% endif %}

                <!-- Next Month Arrow button -->
                <a href="?view=month&year={{ next_year }}&month={{ next_month }}&sort={{ current_sort }}&direction={{ current_direction }}&hide_overdue={{ hide_overdue|yesno:'1,' }}"
                    class="btn btn-outline-secondary" aria-label="Next Month">
                    <i class="fa-solid fa-chevron-right"></i>
                </a>    
             </div>

            <!-- Dropdown for Jump to Month -->
            <div class="dropdown">
                
                <!-- Dropdown button -->
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-label="Jump to Month">
                    Jump toâ€¦
                </button> 
                
                <!-- Dropdown List -->
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><h3 class="dropdown-header h6">{{ today.year }}</h3></li>
                    <!-- Dropdown list items for the current year (from the current month)-->
                    {% for m in today.month|to:12 %}
                        <li>
                            <a class="dropdown-item" 
                            href="?view=month&year={{ today.year }}&month={{ m }}&sort={{ current_sort }}&direction={{ current_direction }}">
                                {{ m|month_name }}
                            </a>
                        </li>
                    {% endfor %}
                    
                    <!-- Divider in the dropdown list to split the current year from next year -->
                    <li><hr class="dropdown-divider"></li>

                    <!-- Dropdown list items for the next calendar year -->
                    <li><h3 class="dropdown-header h6">{{ today.year|add:"1" }}</h3></li>
                    <!-- Months are Int so need to ensure we don't go over 12! -->
                    {% for m in 1|to:12 %}
                        <li>
                            <a class="dropdown-item"
                            href="?view=month&year={{ today.year|add:'1' }}&month={{ m }}&sort={{ current_sort }}&direction={{ current_direction }}">
                                {{ m|month_name }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>  <!-- Dropdown for Jump to Month -->
        </div>  <!-- Column 2: Navigation Buttons + Dropdown -->
    </div>  <!-- Row for header + controls -->
</div>  <!-- Outer container -->

<!-- Hide overdue tasks toggle -->
<div class="row">  <!-- Row for hide overdue toggle -->
    <div>
        <form method="get" class="d-inline">
            <input type="hidden" name="view" value="month">
            <input type="hidden" name="year" value="{{ selected_year }}">
            <input type="hidden" name="month" value="{{ selected_month }}">
            <input type="hidden" name="sort" value="{{ current_sort }}">
            <input type="hidden" name="direction" value="{{ current_direction }}">

            <!-- reloads the page, adds a query parameter to the url if Ticked ("hide_overdue=1"), which Django view uses to filter tasks -->
            <div class="form-check d-inline-block ms-3">
                <input class="form-check-input"
                    type="checkbox"
                    name="hide_overdue"
                    value="1"
                    id="hideOverdueCheck"
                    {% if hide_overdue %}checked{% endif %}
                    onchange="this.form.submit()">
                    <label class="form-check-label" for="hideOverdueCheck">
                        Hide overdue tasks
                    </label>
            </div>
        </form>
    </div>  <!-- Hide overdue tasks toggle -->
</div> <!-- Row for hide overdue toggle -->

<!-- Search + filters -->
<div class="container my-3">
    <div class="row g-2 align-items-end">
        <div class="col-12 col-md-6">
            <label for="dashboard-search" class="form-label mb-1">Search tasks</label>
            <input id="dashboard-search" class="form-control" placeholder="Search by task, plant, or bed...">
        </div>
        <div class="col-6 col-md-3">
            <label for="dashboard-status-filter" class="form-label mb-1">Status</label>
            <select id="dashboard-status-filter" class="form-select">
                <option value="">All</option>
                <option value="overdue">Overdue</option>
                <option value="due-today">Due today</option>
                <option value="scheduled">Scheduled</option>
            </select>
        </div>
    </div>
</div>


<!-- ================================================================================== -->
<!-- ==                Tasks List                                                       -->
<!-- ================================================================================== -->

<!-- ======================================================== -->
<!-- Card version: Hide the cards on d-md and above (>=768px) -->
<!-- ======================================================== -->
<div id="dashboard-cards" class="d-block d-md-none container mb-4"> 
    <div class="row g-3"> <!-- Row for spacing between cards -->

        {% for task in tasks %}
            <!-- Each card takes full width on small screens -->
            <div class="col-12"> 
            
                <!-- Apply the card class based on due date -->
                <div
                    class="card shadow-sm dashboard-card{% if task.next_due < today %} bg-danger {% elif task.next_due == today %} bg-warning{% endif %}"
                    data-task-name="{{ task.name|lower }}"
                    data-plant="{{ task.plant.name|default_if_none:''|lower }}"
                    data-bed="{{ task.plant.bed.name|default_if_none:''|lower }}"
                    data-status="{% if task.next_due < today %}overdue{% elif task.next_due == today %}due-today{% else %}scheduled{% endif %}"
                    data-frequency="{{ task.get_frequency_display|lower }}"
                    data-next-due="{{ task.next_due|date:'Y-m-d' }}"
                >

                    <!-- Card Header -->
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h2 class="card-title mb-0 h5">
                            <a href="{% url 'task_detail' task.id %}">
                                {{ task.name }}
                            </a>

                            {% if task.next_due < today %}
                                <i class="fa-solid fa-circle-exclamation text-danger ms-2"
                                title="This task is overdue"></i>

                            {% elif task.next_due == today %}
                                <i class="fa-solid fa-circle-exclamation text-warning ms-2"
                                title="This task is due today"></i>
                            {% endif %}
                        </h2>
                        <span class="badge bg-secondary">{{ task.status }}</span>
                    </div>

                    <!-- Card Body -->
                    <div class="card-body">

                        <!-- Plant Name -->
                        <div class="mb-2">
                            <strong>Plant:</strong>
                            <!-- Add guard for missing plant -->
                            {% if task.plant %}
                                <a href="{% url 'plant_detail' task.plant.id %}"
                                class="{% if task.next_due < start_of_month %}text-white{% endif %}"
                                aria-label="Link to Plant">
                                    {{ task.plant.name }}
                                </a>
                            {% else %}
                                <span class="{% if task.next_due < start_of_month %}text-white{% else %}text-muted{% endif %}">
                                    No plant
                                </span>
                            {% endif %}
                        </div>

                        <!-- Location -->
                        <div class="mb-2">
                            <strong>Location:</strong>
                            {% if task.plant.bed %}
                                <a href="{% url 'bed_detail' task.plant.bed.id %}"
                                class="{% if task.next_due < start_of_month %}text-white{% endif %}"
                                aria-label="Link to Bed">
                                    {{ task.plant.bed.name }}
                                </a>
                            {% else %}
                                <span class="{% if task.next_due < start_of_month %}text-white{% else %}text-muted{% endif %}">
                                    Unassigned
                                </span>
                            {% endif %}
                        </div>

                        <!-- Due Date -->
                        <div class="mb-2">
                            <strong>Due:</strong> {{ task.next_due }}
                        </div>

                    </div> <!-- Card Body -->

                    <!-- Card Footer (actions) -->
                    <div class="card-footer d-flex justify-content-end gap-2">

                        <!-- Edit -->
                        <a href="{% url 'task_detail' task.id %}" class="btn btn-sm btn-secondary" aria-label="Edit Task {{ task.name }}">Edit</a>

                        <!-- Skip -->
                        <a href="{% url 'task_skip' task.id %}" class="btn btn-sm btn-primary" aria-label="Skip Task {{ task.name }}">Skip</a>

                        <!-- Complete button -->
                        <form method="POST" action="{% url 'task_mark_done' task.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-primary" aria-label="Mark Task {{ task.name }} as Done">
                                {% if task.completed %}
                                    <i class="fa-solid fa-check"></i> Done
                                {% else %}
                                    Done
                                {% endif %}
                            </button>
                        </form>

                    </div> <!-- Card Footer -->

                </div> <!-- End of single card -->
            </div> <!-- col-12 -->

            {% empty %}
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body text-center">
                        <p class="card-text mb-0">Congratulations! You don't have any tasks due with your current filters!</p>
                    </div>
                </div>
            </div>
            {% endfor %}

        </div> <!-- End row for spacing between cards -->
</div> <!-- End container for small screens -->


<!-- ======================================================== -->
<!-- Table version: Hide the table on d-md and below (<768px) -->
<!-- ======================================================== -->
<div class="d-none d-md-block">
    <div class="container mb-4">           <!-- Outer container for spacing -->

        <!-- Table Wrapper: scrollable on smaller screens -->
        <div class="table-responsive">
            <table id="dashboard-table" class="table table-striped table-hover">
                <!-- TABLE HEAD -->
                <thead>
                    <tr>
                        <th class="sortable" data-sort="name">
                            Task <i class="fa-solid fa-arrow-up-long opacity-0 ms-1"></i>
                        </th>
                        <th class="sortable" data-sort="plant">
                            Plant <i class="fa-solid fa-arrow-up-long opacity-0 ms-1"></i>
                        </th>
                        <th class="sortable d-none d-md-table-cell" data-sort="bed">
                            Bed <i class="fa-solid fa-arrow-up-long opacity-0 ms-1"></i>
                        </th>
                        <th class="sortable" data-sort="next_due">
                            Due <i class="fa-solid fa-arrow-up-long opacity-0 ms-1"></i>
                        </th>
                        <th class="sortable d-none d-md-table-cell" data-sort="frequency">
                            Frequency <i class="fa-solid fa-arrow-up-long opacity-0 ms-1"></i>
                        </th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <!-- TABLE BODY -->
                <tbody id="dashboard-table-body">
                    <!-- Loop through tasks -->
                    {% for task in tasks %}
                    
                    <!-- Conditional logic for row highlighting based on due date -->
                    <tr
                        {% if task.next_due < today %}
                            class="table-danger"
                        {% elif task.next_due == today %}
                            class="table-warning"
                        {% endif %}
                        data-task-name="{{ task.name|lower }}"
                        data-plant="{{ task.plant.name|default_if_none:''|lower }}"
                        data-bed="{{ task.plant.bed.name|default_if_none:''|lower }}"
                        data-status="{% if task.next_due < today %}overdue{% elif task.next_due == today %}due-today{% else %}scheduled{% endif %}"
                        data-frequency="{{ task.get_frequency_display|lower }}"
                        data-next-due="{{ task.next_due|date:'Y-m-d' }}"
                    >

                    <!-- Task -->
                    <td>
                        <a href="{% url 'task_detail' task.id %}" aria-label="Link to Task: {{ task.name }}">
                            {{ task.name }}
                        </a>
                    </td>

                    <!--  Plant -->
                    <td>
                        <!-- Add guard for missing plant -->
                        {% if task.plant %}
                            <a href="{% url 'plant_detail' task.plant.id %}" aria-label="Link to Plant: {{ task.plant.name }}">
                                {{ task.plant.name }}
                            </a>
                        {% else %}
                            <span class="text-muted">No plant</span>
                        {% endif %}
                    </td>

                    <!-- bed -->
                    <td class="d-none d-md-table-cell">
                        {% if task.plant.bed %}
                            <a href="{% url 'bed_detail' task.plant.bed.id %}" aria-label="Link to Bed: {{ task.plant.bed.name }}">
                                {{ task.plant.bed.name }}
                            </a>
                        {% else %}
                            <span class="text-muted">Unassigned</span>
                        {% endif %}
                    </td>

                    <!-- Due -->
                    <td>
                        {% if task.next_due < today %}
                            <i class="fa-solid fa-circle-exclamation text-danger ms-2"
                            title="This task is overdue"></i>
                        {% elif task.next_due == today %}
                            <i class="fa-solid fa-circle-exclamation text-warning ms-2"
                            title="This task is due today"></i>
                        {% endif %}
                        {{ task.next_due }}
                    </td>
                    <td class="d-none d-md-table-cell">
                        {{ task.get_frequency_display }}
                    </td>

                    <!-- Actions -->
                    <td class="text-end">
                        <div class="d-flex justify-content-end flex-wrap gap-2">
                            <a href="{% url 'task_update' task.id %}" class="btn btn-sm btn-secondary" style="min-width: 52px;" aria-label="Edit Task {{ task.name }}">Edit</a>
                            <a href="{% url 'task_skip' task.id %}" class="btn btn-sm btn-primary" style="min-width: 52px;" aria-label="Skip Task {{ task.name }}">Skip</a>
                            <form method="POST" action="{% url 'task_mark_done' task.id %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-primary" aria-label="Mark Task {{ task.name }} as Done">
                                    {% if task.completed %}
                                        <i class="fa-solid fa-check"></i> Done
                                    {% else %}
                                        Done
                                    {% endif %}
                                </button>
                            </form>
                        </div>
                    </td>

                    </tr>

                    <!-- If there are no tasks, display message without the table -->
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            Congratulations! You don't have any tasks due with your current filters!
                        </td>
                    </tr>
                    {% endfor %}

                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination for tasks -->
<div id="dashboard-pagination" class="mt-3 d-flex justify-content-center"></div>

{% endblock %}

<!-- Custom JS for pagination, sorting, filtering etc -->
{% block extra_js %}
<script type="module" src="{% static 'assets/js/dashboard.js' %}"></script>
{% endblock %}
