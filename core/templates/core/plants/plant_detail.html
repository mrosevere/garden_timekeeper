{% extends "core/base.html" %}
{% load static %}

{% block content %}

<div class="container mt-4">

    <!-- Page title -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Plant Details: {{ plant.name }}</h2>
        <a href="{% url 'plant_list' %}" class="btn btn-outline-secondary btn-sm">
            Back to Plants
        </a>
    </div>

    <!-- ====================================================== -->
    <!-- Top section: two cards side-by-side on large screens   -->
    <!-- ====================================================== -->
    <div class="row g-3">

        <!-- Left card: Plant details -->
        <div class="col-12 col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Plant Information</span>

                    <div class="d-flex gap-2">
                        <a href="{% url 'plant_edit' plant.pk %}" class="btn btn-sm btn-primary" style="min-width: 60px;" aria-label="Edit plant {{ plant.name }}">
                            Edit
                        </a>
                        <button
                            type="button"
                            class="btn btn-sm btn-danger"
                            data-bs-toggle="modal"
                            data-bs-target="#deletePlantModal"
                            aria-label="Delete plant {{ plant.name }}">
                            Delete
                        </button>
                    </div>
                </div>

                <div class="card-body">

                    <!-- Metadata grid -->
                    <div class="row mb-3">
                        <div class="col-sm-6 mb-2">
                            <strong>Latin Name:</strong><br>
                            {{ plant.latin_name|default:"Not specified" }}
                        </div>
                        <div class="col-sm-6 mb-2">
                            <strong>Lifespan:</strong><br>
                            {% if plant.lifespan %}
                                {{ plant.get_lifespan_display }}
                            {% else %}
                                Not specified
                            {% endif %}
                        </div>
                        <div class="col-sm-6 mb-2">
                            <strong>Type:</strong><br>
                            {% if plant.type %}
                                {{ plant.get_type_display }}
                            {% else %}
                                Not specified
                            {% endif %}
                        </div>
                        <div class="col-sm-6 mb-2">
                            <strong>Planting Date:</strong><br>
                            {{ plant.planting_date|date:"F j, Y"|default:"Not specified" }}
                        </div>
                        <div class="col-sm-6 mb-2">
                            <strong>Garden Bed:</strong><br>
                            {% if plant.bed %}
                                {{ plant.bed.name }}
                            {% else %}
                                Not specified
                            {% endif %}
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="border-top pt-3">
                        <button
                            class="btn btn-sm btn-secondary"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#plantNotesCollapse"
                            aria-controls="plantNotesCollapse"
                            aria-label="Toggle notes for {{ plant.name }}"
                        >
                            Notes
                        </button>

                        <div class="collapse mt-2" id="plantNotesCollapse">
                            <div class="card card-body border-0 p-0">
                                {% if plant.notes %}
                                    {{ plant.notes|safe }}
                                {% else %}
                                    <span class="text-muted">No additional notes.</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Right card: Plant image -->
        <div class="col-12 col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-header">Plant Image</div>
                <div class="card-body d-flex justify-content-center align-items-center plant-image">
                    {% if plant.image %}
                        <img
                            src="{{ plant.image.url }}"
                            alt="{{ plant.name }}"
                            class="img-fluid rounded"
                            style="max-width: 300px; max-height: 300px; object-fit: cover;"
                        >
                    {% else %}
                        <span class="text-muted">No image available.</span>
                    {% endif %}
                </div>
            </div>
        </div>

    </div> <!-- end row -->

    <!-- ====================================================== -->
    <!-- Tasks Section                                          -->
    <!-- ====================================================== -->
    <div class="mt-4">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0">Tasks</h3>
            <a href="{% url 'task_create' plant.id %}" class="btn btn-primary">Add Task</a>
        </div>

        {% if task_info %}

            <!-- Filters -->
            <fieldset class="border-0 p-0 m-0">
                <legend class="visually-hidden">Task Filters</legend>

                <div class="row g-2 mb-3 align-items-end">

                    <div class="col-12 col-md-6">
                        <label for="task-search" class="form-label mb-1">Search Tasks</label>
                        <input id="task-search" class="form-control" placeholder="Search by task name...">
                    </div>

                    <div class="col-6 col-md-3">
                        <label for="status-filter" class="form-label mb-1">Status</label>
                        <select id="status-filter" class="form-select">
                            <option value="">All</option>
                            <option value="overdue">Overdue</option>
                            <option value="due-soon">Due Soon</option>
                            <option value="scheduled">Scheduled</option>
                        </select>
                    </div>

                    <div class="col-6 col-md-3">
                        <label for="season-filter" class="form-label mb-1">Season</label>
                        <select id="season-filter" class="form-select">
                            <option value="">All</option>
                            <option value="in-season">In Season</option>
                            <option value="out-of-season">Out of Season</option>
                        </select>
                    </div>

                </div>
            </fieldset>

            <!-- Desktop table of tasks -->
            <div class="table-responsive d-none d-md-block">
                <table class="table table-striped align-middle" id="plant-tasks-table">
                    <thead>
                        <tr>
                            <th scope="col" class="sortable" data-sort="name" aria-sort="none">
                                <button class="table-sort-btn" aria-label="Sort by Task">
                                    Task
                                    <i class="fa-solid fa-arrow-up-long opacity-0" aria-hidden="true"></i>
                                </button>
                            </th>

                            <th scope="col" class="sortable" data-sort="next_due" aria-sort="none">
                                <button class="table-sort-btn" aria-label="Sort by Next Due">
                                    Next Due
                                    <i class="fa-solid fa-arrow-up-long opacity-0" aria-hidden="true"></i>
                                </button>
                            </th>

                            <th scope="col" class="sortable" data-sort="status" aria-sort="none">
                                <button class="table-sort-btn" aria-label="Sort by Status">
                                    Status
                                    <i class="fa-solid fa-arrow-up-long opacity-0" aria-hidden="true"></i>
                                </button>
                            </th>

                            <th scope="col" class="sortable" data-sort="season" aria-sort="none">
                                <button class="table-sort-btn" aria-label="Sort by Season">
                                    Season
                                    <i class="fa-solid fa-arrow-up-long opacity-0" aria-hidden="true"></i>
                                </button>
                            </th>

                            <th scope="col" class="sortable" data-sort="frequency" aria-sort="none">
                                <button class="table-sort-btn" aria-label="Sort by Frequency">
                                    Frequency
                                    <i class="fa-solid fa-arrow-up-long opacity-0" aria-hidden="true"></i>
                                </button>
                            </th>

                            <th scope="col" class="text-end">Actions</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for item in task_info %}
                            {% with task=item.task %}
                                <tr
                                    class="
                                        {% if item.overdue %}table-danger
                                        {% elif item.due_soon %}table-warning
                                        {% elif not item.in_season %}table-secondary
                                        {% endif %}
                                    "
                                    data-task-name="{{ task.name|lower }}"
                                    data-status="{% if item.overdue %}overdue{% elif item.due_soon %}due-soon{% else %}scheduled{% endif %}"
                                    data-season="{% if item.in_season %}in-season{% else %}out-of-season{% endif %}"
                                    data-frequency="{{ task.get_frequency_display|lower }}"
                                    data-next-due="{{ task.next_due|date:'Y-m-d' }}"
                                >

                                    <td scope="row">
                                        <a href="{% url 'task_detail' task.id %}">
                                            {{ task.name }}
                                        </a>
                                    </td>

                                    <td>
                                        {{ task.next_due|date:"F j, Y"|default:"Not set" }}
                                    </td>

                                    <td>
                                        {% if item.overdue %}
                                            <span class="badge bg-danger">Overdue</span>
                                        {% elif item.due_soon %}
                                            <span class="badge bg-warning text-dark">Due Soon</span>
                                        {% else %}
                                            <span class="badge bg-info text-dark">Scheduled</span>
                                        {% endif %}
                                    </td>

                                    <td>
                                        {% if item.in_season %}
                                            <span class="badge bg-success">In Season</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Out of Season</span>
                                        {% endif %}
                                    </td>

                                    <td>
                                        {{ task.get_frequency_display }}
                                    </td>

                                    <td class="text-end">
                                        <a
                                            href="{% url 'task_update' task.id %}"
                                            class="btn btn-sm btn-secondary"
                                            aria-label="Edit task {{ task.name }}"
                                        >
                                            Edit
                                        </a>

                                        <button
                                            type="button"
                                            class="btn btn-sm btn-danger"
                                            data-bs-toggle="modal"
                                            data-bs-target="#deleteTaskModal{{ task.id }}"
                                            aria-label="Delete task {{ task.name }}"
                                        >
                                            Delete
                                        </button>
                                    </td>

                                </tr>
                            {% endwith %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Mobile cards -->
            <div class="d-md-none">
                {% for item in task_info %}
                    {% with task=item.task %}
                        <div
                            class="card mb-3
                                {% if item.overdue %}border-danger
                                {% elif item.due_soon %}border-warning
                                {% elif not item.in_season %}border-secondary
                                {% endif %}
                            "
                            role="group"
                            aria-label="Task card for {{ task.name }}"
                            data-task-name="{{ task.name|lower }}"
                            data-status="{% if item.overdue %}overdue{% elif item.due_soon %}due-soon{% else %}scheduled{% endif %}"
                            data-season="{% if item.in_season %}in-season{% else %}out-of-season{% endif %}"
                            data-frequency="{{ task.get_frequency_display|lower }}"
                            data-next-due="{{ task.next_due|date:'Y-m-d' }}"
                        >
                            <div class="card-body">

                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h2 class="card-title mb-0 h5">
                                        <a href="{% url 'task_detail' task.id %}">
                                            {{ task.name }}
                                        </a>
                                    </h2>

                                    <div class="text-end">
                                        {% if item.overdue %}
                                            <span class="badge bg-danger">Overdue</span>
                                        {% elif item.due_soon %}
                                            <span class="badge bg-warning text-dark">Due Soon</span>
                                        {% else %}
                                            <span class="badge bg-info text-dark">Scheduled</span>
                                        {% endif %}
                                        <br>
                                        {% if item.in_season %}
                                            <span class="badge bg-success mt-1">In Season</span>
                                        {% else %}
                                            <span class="badge bg-secondary mt-1">Out of Season</span>
                                        {% endif %}
                                    </div>
                                </div>

                                <p class="mb-1">
                                    <strong>Next Due:</strong>
                                    {{ task.next_due|date:"F j, Y"|default:"Not set" }}
                                </p>

                                <p class="mb-2">
                                    <strong>Frequency:</strong>
                                    {{ task.get_frequency_display }}
                                </p>

                                <div class="d-flex flex-wrap gap-2">
                                    <a
                                        href="{% url 'task_update' task.id %}"
                                        class="btn btn-sm btn-secondary"
                                        aria-label="Edit task {{ task.name }}"
                                    >
                                        Edit
                                    </a>

                                    <button
                                        type="button"
                                        class="btn btn-sm btn-danger"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteTaskModal{{ task.id }}"
                                        aria-label="Delete task {{ task.name }}"
                                    >
                                        Delete
                                    </button>
                                </div>

                            </div>
                        </div>
                    {% endwith %}
                {% endfor %}
            </div>

            <!-- Delete Task Modals -->
            {% for item in task_info %}
                {% with task=item.task %}
                    <div
                        class="modal fade"
                        id="deleteTaskModal{{ task.id }}"
                        tabindex="-1"
                        aria-hidden="true"
                    >
                        <div class="modal-dialog">
                            <div class="modal-content">

                                <div class="modal-header">
                                    <h2 class="modal-title h5" id="deleteTaskLabel{{ task.id }}">
                                        Delete Task: {{ task.name }}
                                    </h2>
                                    <button
                                        type="button"
                                        class="btn-close"
                                        data-bs-dismiss="modal"
                                        aria-label="Close delete task modal"
                                    ></button>
                                </div>

                                <div class="modal-body" id="deleteTaskDesc{{ task.id }}">
                                    Are you sure you want to delete <strong>{{ task.name }}</strong>?
                                </div>

                                <div class="modal-footer">
                                    <button
                                        class="btn btn-secondary"
                                        data-bs-dismiss="modal"
                                        aria-label="Cancel deletion of task {{ task.name }}"
                                    >
                                        Cancel
                                    </button>

                                    <form method="post" action="{% url 'task_delete' task.id %}">
                                        {% csrf_token %}
                                        <button
                                            class="btn btn-danger"
                                            aria-label="Confirm delete task {{ task.name }}"
                                        >
                                            Delete
                                        </button>
                                    </form>
                                </div>

                            </div>
                        </div>
                    </div>
                {% endwith %}
            {% endfor %}

        {% else %}
            <p class="text-muted">No tasks yet.</p>
        {% endif %}

        <div id="task-pagination" class="mt-3 d-flex justify-content-center"></div>
    </div>
</div>

<!-- Delete Plant Modal -->
<div
    class="modal fade"
    id="deletePlantModal"
    tabindex="-1"
    aria-hidden="true"
>
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h2 class="modal-title h5" id="deletePlantLabel">
                    Delete Plant: {{ plant.name }}
                </h2>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close delete plant modal"
                ></button>
            </div>

            <div class="modal-body" id="deletePlantDesc">
                Are you sure you want to delete <strong>{{ plant.name }}</strong>?
            </div>

            <div class="modal-footer">
                <button
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                    aria-label="Cancel deletion of plant {{ plant.name }}"
                >
                    Cancel
                </button>

                <form method="post" action="{% url 'plant_delete' plant.pk %}">
                    {% csrf_token %}
                    <button
                        class="btn btn-danger"
                        aria-label="Confirm delete plant {{ plant.name }}"
                    >
                        Delete
                    </button>
                </form>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script type="module" src="{% static 'assets/js/plant_detail.js' %}"></script>
{% endblock %}
